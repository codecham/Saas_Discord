# üîí Guide de Sanitization - Protection XSS

## üìã Table des mati√®res
- [Quand utiliser la sanitization](#quand-utiliser)
- [Exemples d'utilisation](#exemples)
- [Cas d'usage Discord](#cas-discord)
- [Pi√®ges √† √©viter](#pi√®ges)

---

## üéØ Quand utiliser la sanitization ?

### ‚úÖ UTILISER la sanitization dans ces cas :

1. **Affichage de contenu HTML dynamique avec `[innerHTML]`**
   ```html
   <!-- ‚ö†Ô∏è N√âCESSITE sanitization -->
   <div [innerHTML]="messageContent"></div>
   <div [innerHTML]="guildDescription"></div>
   <div [innerHTML]="userBio"></div>
   ```

2. **Contenu provenant de sources externes**
   - Messages Discord (si format√©s en HTML)
   - Descriptions de serveurs
   - Biographies utilisateurs
   - Tout contenu utilisateur avec formatage riche

3. **Markdown converti en HTML**
   ```typescript
   // Si vous convertissez du Markdown Discord en HTML
   const htmlContent = markdownToHtml(discordMessage);
   const safeHtml = this.sanitization.sanitizeHtml(htmlContent);
   ```

### ‚ùå NE PAS utiliser la sanitization dans ces cas :

1. **Interpolation Angular normale**
   ```html
   <!-- ‚úÖ D√âJ√Ä PROT√âG√â par Angular -->
   {{ username }}
   {{ guild.name }}
   {{ message.content }}
   ```

2. **Binding de propri√©t√©s standards**
   ```html
   <!-- ‚úÖ D√âJ√Ä PROT√âG√â par Angular -->
   <img [src]="avatarUrl">
   <a [href]="profileLink">{{ username }}</a>
   <p [title]="tooltipText">Hover me</p>
   ```

3. **Contenu statique**
   ```html
   <!-- ‚úÖ PAS BESOIN -->
   <p>Bienvenue sur notre serveur Discord !</p>
   ```

---

## üìö Exemples d'utilisation

### Exemple 1 : Affichage de messages Discord avec formatage

```typescript
// message.component.ts
import { Component, Input, inject } from '@angular/core';
import { SanitizationService } from '@services/sanitization.service';
import { SafeHtml } from '@angular/platform-browser';

@Component({
  selector: 'app-discord-message',
  template: `
    <div class="message">
      <!-- ‚úÖ Username : interpolation normale (s√©curis√© automatiquement) -->
      <span class="username">{{ message.author }}</span>
      
      <!-- ‚ö†Ô∏è Contenu avec HTML : N√âCESSITE sanitization -->
      <div class="content" [innerHTML]="safeContent"></div>
    </div>
  `
})
export class DiscordMessageComponent {
  @Input() message!: DiscordMessage;
  
  private sanitization = inject(SanitizationService);
  
  get safeContent(): SafeHtml {
    // Sanitize le contenu HTML du message
    return this.sanitization.sanitizeHtml(this.message.content);
  }
}
```

### Exemple 2 : Description de serveur avec formatage

```typescript
// guild-info.component.ts
import { Component, computed, inject } from '@angular/core';
import { SanitizationService } from '@services/sanitization.service';

@Component({
  selector: 'app-guild-info',
  template: `
    <div class="guild-info">
      <!-- ‚úÖ Nom : interpolation normale -->
      <h2>{{ guild().name }}</h2>
      
      <!-- ‚ö†Ô∏è Description avec HTML : sanitization n√©cessaire -->
      <div class="description" [innerHTML]="safeDescription()"></div>
    </div>
  `
})
export class GuildInfoComponent {
  private sanitization = inject(SanitizationService);
  guild = signal<Guild>(...);
  
  safeDescription = computed(() => {
    const desc = this.guild().description || '';
    return this.sanitization.sanitizeHtml(desc);
  });
}
```

### Exemple 3 : Biographie utilisateur

```typescript
// user-profile.component.ts
export class UserProfileComponent {
  private sanitization = inject(SanitizationService);
  
  // Signal pour la bio sanitiz√©e
  safeBio = computed(() => {
    const bio = this.user().bio || 'Aucune biographie';
    // Si la bio contient du HTML, sanitizer
    if (bio.includes('<') || bio.includes('>')) {
      return this.sanitization.sanitizeHtml(bio);
    }
    // Sinon, retourner tel quel (pas de HTML)
    return bio;
  });
}
```

```html
<!-- Template -->
<div class="user-profile">
  <h2>{{ user().username }}</h2>
  
  <!-- Bio avec HTML possible -->
  <div class="bio" [innerHTML]="safeBio()"></div>
</div>
```

---

## üéÆ Cas d'usage Discord sp√©cifiques

### 1. Messages avec formatage Markdown

Discord utilise du Markdown. Si vous le convertissez en HTML :

```typescript
import { marked } from 'marked'; // Exemple de lib Markdown

export class MessageComponent {
  private sanitization = inject(SanitizationService);
  
  get formattedMessage(): SafeHtml {
    // 1. Convertir Markdown ‚Üí HTML
    const html = marked(this.message.content);
    
    // 2. Sanitizer le HTML g√©n√©r√©
    return this.sanitization.sanitizeHtml(html);
  }
}
```

### 2. Embeds Discord

```typescript
export class EmbedComponent {
  @Input() embed!: DiscordEmbed;
  private sanitization = inject(SanitizationService);
  
  get safeDescription(): SafeHtml {
    return this.sanitization.sanitizeHtml(this.embed.description);
  }
  
  get safeFooter(): SafeHtml {
    return this.sanitization.sanitizeHtml(this.embed.footer?.text);
  }
}
```

### 3. Noms de serveurs/channels avec emojis custom

```typescript
// ‚úÖ Interpolation normale suffit
<h2>{{ guild.name }}</h2>

// ‚ùå Pas besoin de sanitization pour les noms
// Les emojis Discord sont juste du texte ou des IDs
```

---

## ‚ö†Ô∏è Pi√®ges √† √©viter

### Pi√®ge 1 : Sur-sanitization

```typescript
// ‚ùå MAUVAIS : Sanitizer inutilement
<p>{{ sanitization.sanitizeHtml(username) }}</p>

// ‚úÖ BON : Interpolation normale
<p>{{ username }}</p>
```

### Pi√®ge 2 : Oublier de sanitizer [innerHTML]

```typescript
// ‚ùå DANGEREUX : Pas de sanitization avec innerHTML
<div [innerHTML]="userContent"></div>

// ‚úÖ S√âCURIS√â : Toujours sanitizer
<div [innerHTML]="sanitization.sanitizeHtml(userContent)"></div>
```

### Pi√®ge 3 : Utiliser `trustHtml` avec du contenu utilisateur

```typescript
// ‚ùå TR√àS DANGEREUX : Ne JAMAIS faire confiance au contenu utilisateur
const unsafe = this.sanitization.trustHtml(userInput);

// ‚úÖ BON : Toujours sanitizer le contenu utilisateur
const safe = this.sanitization.sanitizeHtml(userInput);
```

### Pi√®ge 4 : Ne pas v√©rifier les valeurs null/undefined

```typescript
// ‚ùå PEUT CAUSER DES ERREURS
get safeContent(): SafeHtml {
  return this.sanitization.sanitizeHtml(this.message.content);
}

// ‚úÖ BON : Le service g√®re d√©j√† null/undefined
// Mais vous pouvez ajouter une v√©rification suppl√©mentaire
get safeContent(): SafeHtml {
  if (!this.message?.content) {
    return '';
  }
  return this.sanitization.sanitizeHtml(this.message.content);
}
```

---

## üß™ Comment tester

### Test 1 : V√©rifier que le script est supprim√©

```typescript
const malicious = '<p>Hello <script>alert("XSS")</script></p>';
const safe = this.sanitization.sanitizeHtml(malicious);
// R√©sultat attendu : '<p>Hello </p>' (script supprim√©)
```

### Test 2 : V√©rifier les URLs malveillantes

```typescript
const maliciousUrl = 'javascript:alert("XSS")';
const safe = this.sanitization.sanitizeUrl(maliciousUrl);
// R√©sultat : URL bloqu√©e par Angular
```

### Test 3 : V√©rifier le contenu HTML valide

```typescript
const valid = '<p><strong>Texte en gras</strong></p>';
const safe = this.sanitization.sanitizeHtml(valid);
// R√©sultat : HTML valide conserv√©
```

---

## üìù Checklist avant production

- [ ] Identifier tous les `[innerHTML]` dans votre application
- [ ] V√©rifier que chaque `[innerHTML]` utilise du contenu sanitiz√©
- [ ] V√©rifier qu'aucun `trustHtml` n'est utilis√© avec du contenu utilisateur
- [ ] Tester avec du contenu malveillant (scripts, iframes, etc.)
- [ ] Documenter les endroits o√π la sanitization est utilis√©e

---

## üîó Ressources

- [OWASP XSS Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [Angular Security Guide](https://angular.dev/best-practices/security)
- [DomSanitizer Documentation](https://angular.dev/api/platform-browser/DomSanitizer)

---

**Version :** 1.0.0  
**Derni√®re mise √† jour :** Octobre 2025  
**Maintenu par :** L'√©quipe Frontend

üîí **La s√©curit√© est l'affaire de tous !**